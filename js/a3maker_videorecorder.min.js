class VideoRecorder{constructor(e,t,i){this.mirrorVideo=document.querySelector("#video_preview"),this.component=e,this.targetElement=this.component.originalElement.get(0),this.videoElement=this.targetElement.querySelector("video"),this.isMobile=this.isMobile(),this.stream=null,this.recorder=null,this.recordedBlobs=[],this.isRecording=!1,this.recordingIndicator=this.targetElement.querySelector(".recording-indicator"),this.recordingTimeIndicator=this.targetElement.querySelector(".recording-time"),this.pauseIndicator=this.targetElement.querySelector(".pause-indigator"),this.startTime=null,this.timerInterval=null}isMobile(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}async start(){try{const e={audio:this.component.data.useAudio,video:{width:this.component.data.width,height:this.component.data.height}};if(this.component.data.facingMode==A3Maker.config.CAMERA.FACING_MODE.REAL){if(!this.isMobile)return alert("현재 디바이스에서는 후면 카메라가 지원되지 않습니다."),!1;e.video.facingMode={exact:this.component.data.facingMode}}this.stream=await navigator.mediaDevices.getUserMedia(e),this.videoElement.srcObject=this.stream;return this.videoElement.onloadedmetadata=(()=>{this.videoElement.play()}),!0}catch(e){return alert("사용할 수 있는 카메라가 없습니다"),console.error("카메라 접근 오류:",e),!1}}pause(){this.videoElement.pause(),this.pauseIndicator.style.display="inline",this.recordingIndicator.style.display="none",this.recordingTimeIndicator.style.display="none",this.recorder&&"recording"===this.recorder.state&&this.recorder.pause()}resume(){this.videoElement.play(),this.pauseIndicator.style.display="none",this.recorder&&"paused"===this.recorder.state&&this.recorder.resume()}stop(){this.pause(),this.pauseIndicator.style.display="none",this.recordingIndicator.style.display="none",this.recordingTimeIndicator.style.display="none",this.stream&&this.stream.getTracks().forEach(e=>e.stop()),this.videoElement.srcObject=null,this.recordedBlobs=[],this.mirrorVideo&&(this.mirrorVideo.src="",this.mirrorVideo.removeAttribute("controls"),this.mirrorVideo.style.display="none")}startRecording(){this.stream&&(this.pauseIndicator.style.display="none",this.recordedBlobs=[],this.recorder=new MediaRecorder(this.stream),this.recorder.ondataavailable=(e=>{e.data.size>0&&this.recordedBlobs.push(e.data)}),this.recorder.onstop=(()=>{this.isRecording=!1,this.recordingIndicator.style.display="none",this.recordingTimeIndicator.style.display="none",clearInterval(this.timerInterval),this.startTime=null}),this.recorder.start(),this.isRecording=!0,this.recordingIndicator.style.display="block",this.recordingTimeIndicator.style.display="inline",this.startTime=new Date,this.timerInterval=setInterval(()=>this.updateRecordingTime(),1e3))}stopRecording(){this.pauseIndicator.style.display="none",this.recordingIndicator.style.display="none",this.recordingTimeIndicator.style.display="none",this.isRecording&&this.recorder.stop()}playPreview(){if(this.recordedBlobs.length>0){this.mirrorVideo=document.createElement("video"),this.mirrorVideo.setAttribute("width",this.component.data.width),this.mirrorVideo.setAttribute("height",this.component.data.height),this.mirrorVideo.setAttribute("controls",!0),this.mirrorVideo.style.position="absolute",this.mirrorVideo.style.border="1px solid #222222",this.mirrorVideo.style.top=this.component.data.top+"px",this.mirrorVideo.style.left=this.component.data.left+this.component.data.width+15+"px",this.component.parent.$pageHolderSelector.get(0).appendChild(this.mirrorVideo),this.mirrorVideo.style.display="block";const e=new Blob(this.recordedBlobs,{type:"video/webm"});return this.mirrorVideo.src=URL.createObjectURL(e),this.mirrorVideo.play(),$(this.mirrorVideo).draggable(),!0}return alert("녹화된 영상이 없습니다"),console.log("녹화된 영상이 없습니다."),!1}stopPreview(){this.mirrorVideo.pause(),this.component.parent.$pageHolderSelector.get(0).removeChild(this.mirrorVideo)}updateRecordingTime(){if(!this.startTime)return;const e=new Date,t=Math.floor((e-this.startTime)/1e3),i=Math.floor(t/3600),r=Math.floor(t%3600/60),o=t%60,s=`${i.toString().padStart(2,"0")}:${r.toString().padStart(2,"0")}:${o.toString().padStart(2,"0")}`;this.recordingTimeIndicator.textContent=s}}